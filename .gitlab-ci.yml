image: docker:stable

stages:
- build
- test
- deploy

build-docker:
    services:
    - docker:dind
    before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD

    stage: build
    script:
    - docker build -t reminder-util ./Util
    - docker tag reminder-util igormoura2501/reminder-util:latest
    - docker push igormoura2501/reminder-util:latest

build-project:
    image: igormoura2501/reminder-util:latest
    services:
    - docker:dind
    variables:
        GIT_DEPTH: "1000000"
    stage: build
    script:
    - dotnet build

deploy-nuget:
    image: igormoura2501/reminder-util:latest
    services:
    - docker:dind
    variables:
        GIT_DEPTH: "1000000"
    stage: deploy
    dependencies:
    - build-docker
    - build-project
    script:
    - dotnet pack
    - cd Util
    - cd bin
    - cd Debug
    - dotnet nuget push Reminder-Util.*.nupkg --api-key oy2jwopjk46urhak2feaqp4azipgw2zezcamhtgdomwzu4 --source https://api.nuget.org/v3/index.json